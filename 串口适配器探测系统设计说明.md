# 串口适配器探测系统设计说明

> 本设计文档针对 **`detect_serial_adapters.py`** 单次探测脚本，阐述其功能、运行流程、配置方式以及与 Android APK‑SSH 触发模式的集成方案。脚本运行环境为 **Termux + Proot‑Ubuntu**，所有数据统一存放于 **`/sdcard/isgbackup/serialport/`** 目录。

---

## 1 背景与目标

* **统一探测**：一次性扫描当前设备全部串口（USB/UART），识别 Zigbee、Z‑Wave 适配器及普通串口。
* **轻量触发**：脚本由 Android APK 通过 SSH 调用，**无需常驻或循环**；每次执行即刻返回最新硬件状态。
* **结果落盘**：生成带时间戳的 JSON 结果文件，便于后续对比与追溯。
* **MQTT 上报**：将本次扫描结果以及与上次差异（新增/移除端口）发布到 Broker，供 Home Assistant 等系统订阅。
* **动态配置**：探测逻辑与芯片库分离，**Zigbee 适配器列表迁移至外部 YAML**，便于增补与 OTA 更新。

---

## 2 总体架构

```
+-----------------+        SSH          +------------------------+
|  Android  APK   | --------------->   |  detect_serial_adapters |
+-----------------+                    +------------------------+
                                               │
                                               │ JSON (结果文件)
                                               ▼
                                   /sdcard/isgbackup/serialport/
                                               │
                                               │ MQTT (QoS 1)
                                               ▼
                                  Home Assistant / 监控系统
```

---

## 3 运行流程

1. **读取芯片库**：脚本启动后首先加载 `zigbee_known.yaml` → 得到 `[(vid, pid, name)...]` 列表。
2. **串口扫描**：调用 `pyserial.tools.list_ports.comports()` 获取所有可见串口及其 USB 信息。
3. **设备判定**

   * **Zigbee**：若 VID/PID 命中 YAML 或描述字段包含 `zigbee | cc253 | ezsp …`。
   * **Z‑Wave**：对 *非* Zigbee 端口发送 *GetVersion* 帧 `(0x01 03 00 07 FB)`，若响应帧含 `Z‑Wave` → 判定。
4. **结果整合**：构建结构化列表 `ports[]`；对比最近一次 `latest.json` 计算 `added[] / removed[]`。
5. **文件输出**

   * 写入 `serial_ports_<YYYYMMDDHHMMSS>.json`。
   * 更新（或覆盖）`latest.json`。
6. **MQTT 发布**：主题默认 `isg/serial/scan`，Payload：

   ```jsonc
   {
     "timestamp": "2025-06-29T12:08:00Z",
     "ports": [...],
     "added": [...],
     "removed": [...]
   }
   ```
7. **联动生成器（可选）**：如脚本调用带 `--run-generators`，则根据探测到的端口设置环境变量后执行：

   * `/sdcard/isgbackup/zwave/generate_settings_json.py`
   * `/sdcard/isgbackup/z2m/generate_config_yaml.py`

---

## 4 目录结构

```text
/sdcard/isgbackup/
├─ zwave/
│  ├─ detect_serial_adapters.py     # 主脚本
│  └─ generate_settings_json.py     # 已有脚本（Z‑Wave）
├─ z2m/
│  └─ generate_config_yaml.py       # 已有脚本（Zigbee2MQTT）
└─ serialport/
   ├─ zigbee_known.yaml             # Zigbee VID/PID 列表
   ├─ serial_ports_20250629120800.json
   └─ latest.json                   # 最近一次结果（软链或覆盖）
```

---

## 5 `zigbee_known.yaml` 规范

```yaml
# 每条记录包含 VID、PID（十六进制或十进制均可）与可读名称
- vid: 0x10C4      # Silicon Labs CP210x
  pid: 0xEA60
  name: CP2102/EZSP
- vid: 0x0403      # FTDI 系列
  pid: 0x6015
  name: FTDI CC2652P
- vid: 0x1A86
  pid: 0x55D4
  name: CH34x Zigbee
```

> **扩展方式**：新增行即可；脚本每次启动均重新加载 YAML，无需重启服务。

---

## 6 脚本参数与示例

| 参数                 | 说明                         | 默认值               |
| ------------------ | -------------------------- | ----------------- |
| `--mqtt-broker`    | MQTT 服务器地址                 | *必填*              |
| `--mqtt-port`      | 端口                         | `1883`            |
| `--mqtt-user/pass` | 认证信息（可选）                   | `None`            |
| `--topic`          | 上报主题                       | `isg/serial/scan` |
| `--retain`         | 发布保留标志                     | `False`           |
| `--run-generators` | 扫描完成后自动写入 Z‑Wave/Zigbee 配置 | 不执行               |
| `-v / -vv`         | 日志级别                       | INFO / DEBUG      |

### 典型调用（APK 经 SSH）

```bash
python /sdcard/isgbackup/zwave/detect_serial_adapters.py \
       --mqtt-broker 127.0.0.1 --retain --run-generators
```

> APK 通过 `Runtime.exec()` 或 `com.hierynomus.ssh` 执行上述命令，并可监听脚本标准输出判断成功或失败。

---

## 7 结果 JSON 示例

```json
{
  "timestamp": "2025-06-29T12:08:00Z",
  "ports": [
    {
      "device": "/dev/ttyUSB0",
      "vid": 4292,
      "pid": 59936,
      "product": "CP2102 USB to UART Bridge",
      "is_zigbee": true,
      "is_zwave": false
    },
    {
      "device": "/dev/ttyUSB1",
      "vid": 1027,
      "pid": 24577,
      "product": "Silicon Labs HubZ Z‑Wave",
      "is_zigbee": false,
      "is_zwave": true
    }
  ],
  "added": [ { "device": "/dev/ttyUSB1", ... } ],
  "removed": []
}
```

---

## 8 APK 集成注意事项

1. **权限**：APK 侧需确保已 root 或使用 `adb tcpip` 开启 8022 端口，并具备 SSH 密钥或密码登录。
2. **超时控制**：建议给脚本执行设置 5–10 s 超时；若超时可重试或提示用户检查 USB 连接。
3. **并发调用**：避免短时间内多次并发调用；若业务需要，可使用脚本 `--lock-file /tmp/scan.lock` 机制（未来可扩展）。
4. **结果消费**：APK 可直接读取 `/sdcard/isgbackup/serialport/latest.json` 或订阅 MQTT 主题实时获取。

---

## 9 优化与扩展建议

| 方向              | 说明                                                   |
| --------------- | ---------------------------------------------------- |
| **异步 I/O**      | 使用 `asyncio` + `pyserial‑asyncio` 并行探测多口，降低总耗时。      |
| **Prometheus**  | 增加 `--prom-port` 导出 `/metrics`，便于 Grafana 观测。        |
| **自动固件识别**      | 读取 Z‑Wave GetVersion 字符串可进一步区分 500/700/800 系列。       |
| **OTA 更新 YAML** | APK 每次启动可从远端拉取最新 `zigbee_known.yaml` 覆盖本地文件。         |
| **WebHook**     | 除 MQTT 外，可向 HTTP Webhook 推送，兼容 InfluxDB/ThingsBoard。 |

---

## 10 FAQ

* **Q: YAML 写十进制还是十六进制？**  → 两者皆可，脚本内部会统一转为 `int` 比较。
* **Q: 为什么脚本仍未识别我的 Zigbee 适配器？**  → 请确认是否已在 YAML 中添加 VID/PID；或检查 USB OTG 供电。
* **Q: Z‑Wave 检测误报**  → 某些串口会回显 `0x01` 且包含 "Z‑Wave" 字样的 debug 日志，建议串口开启前先清空输入缓存。

---

> 文档版本：v1.0  |  作者：ChatGPT 4o  |  更新时间：2025‑06‑29
